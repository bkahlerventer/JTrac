<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE beans PUBLIC "-//SPRING//DTD BEAN//EN" "http://www.springframework.org/dtd/spring-beans.dtd">

<!-- Acegi security configuration as Spring context -->

<beans>
	
    <!-- Automatically receives AuthenticationEvent messages -->
    <bean id="loggerListener" class="org.acegisecurity.event.authentication.LoggerListener"/>    
    
    <!-- has to be first in the filter chain, this injects the security / session context for all the rest -->
    <bean id="httpSessionFilter" class="org.acegisecurity.context.HttpSessionContextIntegrationFilter"/>      
    
    <bean id="anonFilter" class="org.acegisecurity.providers.anonymous.AnonymousProcessingFilter">
        <property name="key" value="jtrac-anon"/>
        <property name="userAttribute" value="anonymousUser,ROLE_ANONYMOUS"/>
    </bean> 
    
    <bean name="authorizationFilter" class="org.acegisecurity.intercept.web.FilterSecurityInterceptor">
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="accessDecisionManager">
            <bean class="org.acegisecurity.vote.AffirmativeBased">
                <property name="allowIfAllAbstainDecisions" value="false"/>
                <property name="decisionVoters">
                    <list>
                        <bean class="org.acegisecurity.vote.RoleVoter"/>
                    </list>
                </property>
            </bean>		      
        </property>     
        <property name="objectDefinitionSource">
            <value>
                PATTERN_TYPE_APACHE_ANT
                /index.jsp=ROLE_ANONYMOUS,ROLE_USER
                /casfailed.jsp=ROLE_ANONYMOUS,ROLE_USER
                /test/**=ROLE_ANONYMOUS,ROLE_USER
                /resources/**=ROLE_ANONYMOUS,ROLE_USER
                /calendar/**=ROLE_ANONYMOUS,ROLE_USER
                /chart/*=ROLE_ANONYMOUS,ROLE_USER
                /svn_*=ROLE_ANONYMOUS,ROLE_USER                 
                /login.htm*=ROLE_ANONYMOUS,ROLE_USER
                /logout.htm=ROLE_ANONYMOUS,ROLE_USER
                /**=ROLE_USER
            </value>
        </property>
    </bean>  
    
    <!-- ============================ NON-CAS ============================= -->   
    
    <bean id="filterChainProxy" class="org.acegisecurity.util.FilterChainProxy">
        <property name="filterInvocationDefinitionSource">
            <value>
                PATTERN_TYPE_APACHE_ANT
                /**=httpSessionFilter,authenticationFilter,rememberMeFilter,anonFilter,exceptionTranslationFilter,authorizationFilter
            </value>
        </property>
    </bean>    
    
    <bean id="authenticationManager" class="org.acegisecurity.providers.ProviderManager">
        <property name="providers">
            <list>
                <bean class="org.acegisecurity.providers.dao.DaoAuthenticationProvider">
                    <property name="userDetailsService" ref="jtrac"/>
                    <property name="passwordEncoder" ref="passwordEncoder"/>
                </bean> 
                <bean class="org.acegisecurity.providers.anonymous.AnonymousAuthenticationProvider">
                    <property name="key" value="jtrac-anon"/>
                </bean>
                <bean class="org.acegisecurity.providers.rememberme.RememberMeAuthenticationProvider">
                    <property name="key" value="jtrac-reme"/>
                </bean>		   
            </list>
        </property>
    </bean>
  
    <bean id="authenticationFilter" class="org.acegisecurity.ui.webapp.AuthenticationProcessingFilter">
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="authenticationFailureUrl" value="/login.htm?error=true"/>
        <property name="defaultTargetUrl" value="/dashboard.htm"/>
        <property name="filterProcessesUrl" value="/j_acegi_security_check"/>
        <property name="rememberMeServices" ref="rememberMeServices"/>
    </bean>   
              
    <bean id="exceptionTranslationFilter" class="org.acegisecurity.ui.ExceptionTranslationFilter">
        <property name="authenticationEntryPoint">
            <bean class="org.acegisecurity.ui.webapp.AuthenticationProcessingFilterEntryPoint">
                <property name="loginFormUrl" value="/login.htm"/>
            </bean>      
        </property>
    </bean>
    
    <bean id="rememberMeFilter" class="org.acegisecurity.ui.rememberme.RememberMeProcessingFilter">
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="rememberMeServices" ref="rememberMeServices"/>
    </bean>
   
    <bean id="rememberMeServices" class="org.acegisecurity.ui.rememberme.TokenBasedRememberMeServices">
        <property name="userDetailsService" ref="jtrac"/>
        <property name="key" value="jtrac-reme"/>
    </bean>      
    
    <!-- ========================  CAS ============================ -->
    
    <!--
    
    <bean id="filterChainProxy" class="org.acegisecurity.util.FilterChainProxy">
        <property name="filterInvocationDefinitionSource">
            <value>
                PATTERN_TYPE_APACHE_ANT
                /**=httpSessionFilter,authenticationFilter,anonFilter,exceptionTranslationFilter,authorizationFilter
            </value>
        </property>
    </bean>      
    
    <bean id="serviceProperties" class="org.acegisecurity.ui.cas.ServiceProperties">
        <property name="service" value="https://localhost/jtrac/j_acegi_cas_security_check"/>
        <property name="sendRenew" value="false"/>
    </bean>
    
    <bean id="authenticationFilter" class="org.acegisecurity.ui.cas.CasProcessingFilter">
        <property name="authenticationManager" ref="authenticationManager"/>
        <property name="authenticationFailureUrl" value="/casfailed.jsp"/>
        <property name="defaultTargetUrl" value="/"/>
        <property name="filterProcessesUrl" value="/j_acegi_cas_security_check"/>
    </bean>
    
    <bean id="exceptionTranslationFilter" class="org.acegisecurity.ui.ExceptionTranslationFilter">
        <property name="authenticationEntryPoint" ref="casProcessingFilterEntryPoint"/>
    </bean>  
    
    <bean id="casProcessingFilterEntryPoint" class="org.acegisecurity.ui.cas.CasProcessingFilterEntryPoint">
        <property name="loginUrl" value="https://localhost/cas/login"/>
        <property name="serviceProperties" ref="serviceProperties"/>
    </bean>   
 
    <bean id="authenticationManager" class="org.acegisecurity.providers.ProviderManager">
        <property name="providers">
            <list>
                <ref local="casAuthenticationProvider"/>
            </list>
        </property>
    </bean>    
    
    <bean id="casAuthenticationProvider" class="org.acegisecurity.providers.cas.CasAuthenticationProvider">
        <property name="casAuthoritiesPopulator" ref="casAuthoritiesPopulator"/>
        <property name="casProxyDecider" ref="casProxyDecider"/>
        <property name="ticketValidator" ref="casProxyTicketValidator"/>
        <property name="statelessTicketCache" ref="statelessTicketCache"/>
        <property name="key" value="my_password_for_this_auth_provider_only"/>
    </bean>    
        
    <bean id="casProxyTicketValidator" class="org.acegisecurity.providers.cas.ticketvalidator.CasProxyTicketValidator">
        <property name="casValidate" value="https://localhost/cas/proxyValidate"/>
        <property name="proxyCallbackUrl" value="https://localhost/jtrac/casProxy/receptor"/>
        <property name="serviceProperties" ref="serviceProperties"/>
        <property name="trustStore" value="/some/path/to/your/lib/security/cacerts"/>
    </bean>

    <bean id="cacheManager" class="org.springframework.cache.ehcache.EhCacheManagerFactoryBean">
        <property name="configLocation" value="classpath:/ehcache-failsafe.xml"/>        
    </bean>

    <bean id="ticketCacheBackend" class="org.springframework.cache.ehcache.EhCacheFactoryBean">
        <property name="cacheManager" ref="cacheManager"/>        
        <property name="cacheName" value="ticketCache"/>        
    </bean>

    <bean id="statelessTicketCache" class="org.acegisecurity.providers.cas.cache.EhCacheBasedTicketCache">
        <property name="cache" ref="ticketCacheBackend"/>
    </bean>

    <bean id="casAuthoritiesPopulator" class="org.acegisecurity.providers.cas.populator.DaoCasAuthoritiesPopulator">
        <property name="userDetailsService" ref="jtrac"/>
    </bean>

    <bean id="casProxyDecider" class="org.acegisecurity.providers.cas.proxy.RejectProxyTickets"/>    	         
 
   <bean id="basicProcessingFilter" class="org.acegisecurity.ui.basicauth.BasicProcessingFilter">
      <property name="authenticationManager" ref="authenticationManager"/>
      <property name="authenticationEntryPoint" ref="basicProcessingFilterEntryPoint"/>
   </bean>

   <bean id="basicProcessingFilterEntryPoint" class="org.acegisecurity.ui.basicauth.BasicProcessingFilterEntryPoint">
      <property name="realmName" value="jtrac-realm"/>
   </bean>    
    
   -->
   
</beans>


